### 公平组合游戏（ICG）

若一个游戏满足：

1. 由两名玩家交替行动

2. 在游戏进程的任意时刻，可以执行的合法行动与轮到哪名玩家无关

3. 不能行动的玩家判负

则称该游戏为一个公平组合游戏。

Nim博弈属于公平组合游戏，但城建类的游戏，比如围棋，就不是公平组合游戏，因为玩家下的棋子颜色不同，不符合“可以执行的合法行动与轮到哪名玩家无关”，判定获胜的过程也不是不能行动就输了。

### 有向图游戏

给定一个有向无环图，图中有一个唯一的起点，在起点上放有一枚棋子。两名玩家交替地把这枚棋子沿着有向边进行移动，每次可以移动一步，无法移动者判负，该游戏被称为有向图游戏。

任何一个公平组合游戏都可以转化为有向图游戏。具体方法是：把每个局面看成图中的一个结点，并且从每个局面向沿着合法行动能够到达的下一个局面连有向边。

### Nim游戏

给定$N$堆物品，第$i$堆物品有$A_i$个，两名玩家轮流行动，每次可以任选一堆，取走任意多个物品，可以把一堆取光，但不能不取，取走最后一件物品者获胜。两人都采取最优策略，问先手是否必胜。

这种游戏被称为Nim博弈，把游戏过程中面临的状态称为局面。所谓采取最优策略是指，若在某一局面下存在某种行动，使得行动后对面面临必败的局面，则优先采取该行动，同时，这样的局面称为必胜。

Nim博弈不存在平局，只有先手必胜和先手必败两种情况。

定理：**Nim博弈先手必胜，当且仅当$A_1 \otimes A_2 \otimes ... \otimes A_n \neq 0$，其中$\otimes$是异或**。

#### 必胜状态和必败状态

- 先手必胜状态：
如果当前有某种操作，能够让玩家操作之后，局面变成“先手必败状态”，则当前的状态就是“先手必胜状态”。

- 先手必败状态：
当前不管怎么操作，下一个状态都是“先手必胜状态”，则当前的状态是“先手必败状态”。

#### 证明

在游戏的终点，异或值一定是$0 \otimes 0 \otimes 0 \otimes ... = 0$，如果某个状态异或值不是$0$：
$$
A_1 \otimes A_2 \otimes ... \otimes A_n = X \neq 0
$$
一定可以通过某个合法的Nim游戏操作（从某一堆里拿走若干物品）让它的异或值变成$0$。

假设$X$的二进制表示中最高一位$1$在第$k$位，则$A_1$到$A_n$中必然有一个数$A_i$，它的第$k$位是$1$，并且$A_i \otimes X < A_i$，因为这个异或会把$A_i$的第$k$位从$1$变成$0$，而更高的位不变，所以就可以从$A_i$这堆中拿走$A_i - A_i \otimes X$这么多的物品，使得$A_i$这堆物品变成$A_i \otimes X$个，从而异或结果变成$0$。

而异或值是$0$的局面，不论怎么拿，剩余所有数的异或值一定不是$0$，所以就是必败状态。这个可以用反证法来证明，如果是把$A_i$拿走了一部分变成了$A_i'$，并且异或结果还是$0$，那就是：
$$
A_1 \otimes A_2 \otimes ... \otimes A_i \otimes ... \otimes A_n = 0 \\
A_1 \otimes A_2 \otimes ... \otimes A_i' \otimes ... \otimes A_n = 0
$$
上下两个式子异或，得到$A_i \otimes A_i' = 0$，所以$A_i = A_i'$，即没拿，不符合Nim游戏规则。

### Mex运算

对集合的一个运算，是找到集合中不存在的最小的自然数，比如$S = \{0,1,3\}$，则$mex(S)=2$。

### SG函数

各个局面可以构成一个状态机，SG函数是定义在状态结点上的函数，可以将终点状态的SG函数定义为$0$：
$$
SG(终点) = 0
$$
某一个非终止状态$x$的SG函数定义为：
$$
SG(x) = mex(\{SG(y_1), SG(y_2), ..., SG(y_k)\})
$$
其中$y_1$到$y_n$是$x$的所有后继状态，它们的SG函数值组成的集合再进行Mex运算得到的就是状态$x$的SG函数。

**在公平组合游戏里，必败状态$SG(x)=0$，必胜状态$SG(x) \neq 0$**。

因为终止状态是失败的，$SG(x)=0$，如果$SG(x) \neq 0$，那么说明它一定是能到$0$的，所以可以操作一下让局面变成$SG(y) = 0$的状态$y$。

而处在$SG(x)=0$的玩家，即使能走，也不管怎么走都只能走到$SG(y) \neq 0$的状态，也就是只能让对方进入必胜状态，自己就是必败状态。

### 多个局面图的情况

当有多个不连通的局面图时（玩家每次只能在一个局面图上移动局面），只要所有图的当前状态的SG函数异或起来值是$0$那么就失败，而根据SG函数定义，如果$SG(x) > 0$，一定可以走到SG比它小的各个取值的状态上，这个就变成了一个Nim游戏的模型，所以**只要把所有图的当前状态的SG函数值异或起来，不为$0$就说明是必胜的了**。